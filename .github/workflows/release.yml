name: Release Drafter and Publisher

on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    branches:
      - develop
      - main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-drafter
  cancel-in-progress: true

jobs:

  update_release_draft:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed' || github.event.pull_request.merged == true
    steps:
      - uses: actions/checkout@v4
      - uses: release-drafter/release-drafter@v6.0.0
        with:
          config-name: release-drafter.yml
          # commitish adjusts release history depending on branch
          commitish: ${{ github.base_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------
  # Publish from DEVELOP → Pre-Release
  # ------------------------------
  publish_prerelease:
    if: >
      github.event.pull_request.merged == true &&
      github.base_ref == 'develop' &&
      contains(github.event.pull_request.labels.*.name, 'Publish')
    needs: update_release_draft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const draft = releases.data.find(r => r.draft);
            if (!draft) { core.setFailed("No draft release found."); return; }
            await github.rest.repos.updateRelease({
              owner, repo, release_id: draft.id,
              draft: false,
              prerelease: true
            });
            console.log(`✅ Published PRE-RELEASE on develop: ${draft.tag_name}`);

  # ------------------------------
  # Publish from MAIN → Stable Release
  # ------------------------------
  publish_stable:
    if: >
      github.event.pull_request.merged == true &&
      github.base_ref == 'main' &&
      contains(github.event.pull_request.labels.*.name, 'Publish')
    needs: update_release_draft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const releases = await github.rest.repos.listReleases({ owner, repo });
            const draft = releases.data.find(r => r.draft);
            if (!draft) { core.setFailed("No draft release found."); return; }
            await github.rest.repos.updateRelease({
              owner, repo, release_id: draft.id,
              draft: false,
              prerelease: false
            });
            console.log(`✅ Published STABLE RELEASE on main: ${draft.tag_name}`);
